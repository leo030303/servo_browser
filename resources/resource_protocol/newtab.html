<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Tab</title>
  <link rel="stylesheet" href="resource:///newtab.css">
</head>

<body>
  <div class="container">
    <img src="resource:///servo-color-negative-no-container.svg" draggable="false">
    <form class="search-container" action="https://www.ecosia.org/search">
      <input name="q" placeholder="Search the webâ€¦" autofocus>
      <button type="submit" class="search-button" aria-label="Search">
        <img src="resource:///search.svg" alt="">
      </button>
    </form>

    <div class="pinned-grid" id="grid"></div>
  </div>

  <dialog id="dialog">
    <h3>Edit Pinned Site</h3>
    <input id="name" placeholder="Name">
    <input id="url" placeholder="https://example.com">
    <div class="dialog-actions">
      <button id="save">Save</button>
      <button id="cancel" type="button">Cancel</button>
    </div>
  </dialog>

  <script>
    const COUNT = 6;
    const KEY = 'pinnedSites';

    const grid = document.getElementById('grid');
    const dialog = document.getElementById('dialog');
    const nameInput = document.getElementById('name');
    const urlInput = document.getElementById('url');

    let editIndex = null;
    let dragFromIndex = null;

    function loadPins() {
      try {
        const data = JSON.parse(localStorage.getItem(KEY));
        if (Array.isArray(data) && data.length === COUNT) return data;
      } catch (e) { }
      return Array.from({length: COUNT}, () => ({name: 'Add site', url: ''}));
    }

    const pins = loadPins();

    function save() {
      localStorage.setItem(KEY, JSON.stringify(pins));
    }

    function favicon(url) {
      try {
        return new URL(url).origin + '/favicon.ico';
      } catch {
        return '';
      }
    }

    function render() {
      grid.innerHTML = '';

      pins.forEach((pin, i) => {
        const el = document.createElement('div');
        el.className = 'pin';
        el.dataset.index = i;

        el.innerHTML = `
          <div class="pin-handle" draggable="true">
            <svg height="16px" viewBox="0 0 16 16" width="16px" xmlns="http://www.w3.org/2000/svg">
                <path d="m 4.496094 0 c -0.832032 0 -1.5 0.671875 -1.5 1.5 s 0.667968 1.5 1.5 1.5 c 0.828125 0 1.5 -0.671875 1.5 -1.5 s -0.671875 -1.5 -1.5 -1.5 z m 6 0 c -0.832032 0 -1.5 0.671875 -1.5 1.5 s 0.667968 1.5 1.5 1.5 c 0.828125 0 1.5 -0.671875 1.5 -1.5 s -0.671875 -1.5 -1.5 -1.5 z m -6 6 c -0.832032 0 -1.5 0.671875 -1.5 1.5 s 0.667968 1.5 1.5 1.5 c 0.828125 0 1.5 -0.671875 1.5 -1.5 s -0.671875 -1.5 -1.5 -1.5 z m 6 0 c -0.832032 0 -1.5 0.671875 -1.5 1.5 s 0.667968 1.5 1.5 1.5 c 0.828125 0 1.5 -0.671875 1.5 -1.5 s -0.671875 -1.5 -1.5 -1.5 z m -6 6 c -0.832032 0 -1.5 0.671875 -1.5 1.5 s 0.667968 1.5 1.5 1.5 c 0.828125 0 1.5 -0.671875 1.5 -1.5 s -0.671875 -1.5 -1.5 -1.5 z m 6 0 c -0.832032 0 -1.5 0.671875 -1.5 1.5 s 0.667968 1.5 1.5 1.5 c 0.828125 0 1.5 -0.671875 1.5 -1.5 s -0.671875 -1.5 -1.5 -1.5 z m 0 0" fill="#888888"/>
            </svg>
          </div>
          <div class="pin-edit">
            <svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 0 16 16" width="16px"><path d="m 12.277344 0.832031 c -0.578125 0.007813 -1.167969 0.230469 -1.691406 0.753907 l -9 9 c -0.375 0.375 -0.585938 0.882812 -0.585938 1.414062 v 3 h 3 c 0.53125 0 1.039062 -0.210938 1.414062 -0.585938 l 9 -9 c 1.789063 -1.789062 0.082032 -4.390624 -1.890624 -4.570312 c -0.082032 -0.011719 -0.164063 -0.011719 -0.246094 -0.011719 z m -1.777344 3.605469 l 1.058594 1.0625 l -0.527344 0.53125 l -6.53125 6.53125 l -1.0625 -1.0625 z m 0 0" fill="#888888"/></svg>
          </div>
          <div class="pin-icon">${pin.url ? `<img src="${favicon(pin.url)}">` : '+'}</div>
          <div class="pin-name">${pin.name}</div>
        `;

        const handle = el.querySelector('.pin-handle');
        const editBtn = el.querySelector('.pin-edit');

        handle.addEventListener('dragstart', () => {
          dragFromIndex = i;
          el.classList.add('dragging');
        });

        handle.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          dragFromIndex = null;
          save();
        });

        editBtn.onclick = (e) => {
          e.stopPropagation();
          editIndex = i;
          nameInput.value = pin.name === 'Add site' ? '' : pin.name;
          urlInput.value = pin.url;
          dialog.showModal();
        };

        el.onclick = () => {
          if (pin.url) window.location.href = pin.url;
        };

        grid.appendChild(el);
      });
    }

    grid.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (dragFromIndex === null) return;

      const children = [...grid.children];
      const overEl = children.find(child => {
        const rect = child.getBoundingClientRect();
        return e.clientX < rect.left + rect.width / 2;
      });

      const overIndex = overEl ? Number(overEl.dataset.index) : children.length - 1;
      if (overIndex === dragFromIndex) return;

      const [moved] = pins.splice(dragFromIndex, 1);
      pins.splice(overIndex, 0, moved);
      dragFromIndex = overIndex;

      render();
    });

    document.getElementById('save').onclick = () => {
      if (editIndex === null) return;
      pins[editIndex] = {
        name: nameInput.value || 'Unnamed',
        url: urlInput.value.trim()
      };
      save();
      render();
      dialog.close();
    };

    document.getElementById('cancel').onclick = () => dialog.close();

    dialog.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('save').click();
      }

      if (e.key === 'Escape') {
        e.preventDefault();
        dialog.close();
      }
    });


    render();
  </script>
</body>

</html>